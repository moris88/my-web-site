name: LLaMA Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review_code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
            fetch-depth: 0  # Scarica l'intera cronologia git

      - name: Analyze code with LLaMA (Hugging Face)
        id: llama-review
        run: |
          # Set the base and head commit
          BASE_COMMIT=$(git merge-base HEAD ${{ github.event.pull_request.base.ref }})
          HEAD_COMMIT=${{ github.sha }}
          
          # Get the modified files between the commits
          MODIFIED_FILES=$(git diff --name-only $BASE_COMMIT $HEAD_COMMIT)

          # Hugging Face API URL and token
          HF_API_URL="https://api-inference.huggingface.co/models/meta-llama/Llama-2-7b-chat-hf"
          HF_API_TOKEN="${{ secrets.HUGGINGFACE_API_TOKEN }}"

          # Loop through the modified files and send them to LLaMA for analysis
          for file in $MODIFIED_FILES; do
            if [[ $file == *.js || $file == *.ts || $file == *.jsx || $file == *.tsx ]]; then
              echo "Reviewing $file"
              FILE_CONTENT=$(cat "$file")

              # Prepare JSON payload
              PAYLOAD=$(jq -n --arg content "$FILE_CONTENT" '{ "inputs": $content }')

              # Call Hugging Face API for LLaMA analysis
              REVIEW=$(curl -X POST "$HF_API_URL" \
              -H "Authorization: Bearer $HF_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

              echo "LLaMA Review: $REVIEW"
            fi
          done

      - name: Create PR comment with LLaMA review
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## LLaMA Review

            Here are the insights for your code:
            - **Logic and Syntax Errors:**
              - [list detected errors from the LLaMA response]
            - **Potential Issues:**
              - [list possible issues]
            - **Suggestions:**
              - [list possible improvements]

            _Review was generated by LLaMA via Hugging Face API._
